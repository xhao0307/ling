# AGENTS 工作规范（长任务增量开发）

本文档用于约束本仓库中的 Codex/Agent 行为。只要在本项目目录下启动新会话，均应遵循本规范。

## 1. 总目标

- 目标是跨多个上下文窗口持续推进任务，而不是单次“做完全部”。
- 每个会话都必须产生可验证的增量成果，并留下清晰交接信息。
- 任何会话结束时，代码库应保持“可继续开发”的干净状态。

## 2. 角色与阶段

- 首次会话使用“初始化阶段”（Initializer）。
- 后续会话使用“增量开发阶段”（Coding）。

## 3. 初始化阶段（仅首次或缺失脚手架时执行）

首次进入项目时，若以下文件不存在，必须先创建并提交：

- `init.sh`：一键启动项目与基础自检脚本。
- `feature_list.json`：完整功能清单（结构化 JSON），每项包含可验证步骤与 `passes` 字段。
- `agent-progress.md`：会话交接日志。

初始化完成后，必须有一次独立提交，提交信息示例：

- `chore(init): 初始化长任务脚手架与功能清单`

## 4. feature_list 规则

- `feature_list.json` 必须使用 JSON，不使用 Markdown 清单。
- 每个功能项应至少包含：
  - `id`
  - `category`
  - `description`
  - `steps`（端到端验证步骤）
  - `passes`（布尔值）
  - `priority`
- 默认所有功能 `passes=false`，只允许在验证通过后改为 `true`。
- 严禁删除或弱化测试步骤来“让功能看起来完成”。
- 严禁随意重写既有功能项；仅允许补充必要字段或修正明显错误。

## 5. 每个会话的固定启动流程

每次新会话必须按顺序执行：

1. `pwd`，确认当前目录。
2. `git status` 与 `git log --oneline -20`，了解最近变更。
3. 阅读 `agent-progress.md`，理解上次会话结论与阻塞点。
4. 阅读 `feature_list.json`，选择最高优先级且 `passes=false` 的单个功能。
5. 执行 `init.sh`，确认项目可启动，并完成最小 smoke test。

若 smoke test 失败，优先修复基础可用性，禁止直接开始新功能开发。

## 6. 增量开发规则（核心）

- 单会话只做一个功能点（或一个明确子任务）。
- 禁止一次性并行实现多个大功能。
- 改动应尽量小、可回滚、可审阅。
- 必须保留可读代码结构，不引入无关重构。

## 7. 测试与验收规则

- 功能完成判定以“端到端可验证”为准，不只看代码或单测。
- Web 场景优先使用浏览器自动化（例如 `chrome-devtools-mcp`）做关键路径验证。
- 至少提供以下证据之一写入进展日志：
  - 关键命令与返回摘要
  - 端到端操作结果摘要
  - 失败原因与复现步骤
- 未通过验证时，不得将对应 `passes` 改为 `true`。

## 8. 会话结束前必须完成的交接动作

每个会话结束前必须完成：

1. 更新 `agent-progress.md`（见第 9 节模板）。
2. 更新 `feature_list.json` 中对应项的 `passes` 状态（仅在通过验证后）。
3. 提交代码，提交信息需明确功能与验证状态。

推荐提交信息格式：

- `feat(feature-id): 完成 xxx 并通过 e2e 验证`
- `fix(feature-id): 修复 xxx 阻塞问题`
- `chore: 更新进展记录与脚手架`

## 9. agent-progress 记录模板

`agent-progress.md` 每次追加一节，建议使用以下结构：

- 日期时间
- 会话目标（本次只做哪一个功能）
- 实际改动（文件与行为摘要）
- 验证结果（命令、端到端结果、是否通过）
- 风险与遗留问题
- 下一会话建议（下一优先级功能）

## 10. 失败与阻塞处理

- 遇到阻塞时，必须先记录：
  - 复现步骤
  - 已尝试方案
  - 建议下一步
- 禁止在阻塞状态下“宣布整体完成”。
- 禁止跳过测试直接更新 `passes=true`。

## 11. 禁止事项

- 禁止删除测试或绕过验收逻辑来追求“看起来完成”。
- 禁止在未验证通过时声明功能已完成。
- 禁止在脏环境中结束会话（明显坏状态、无法启动、无交接记录）。

## 12. 语言与沟通

- 对外说明、进展记录、提交说明默认使用中文。
- 回答应简洁、可执行、可追溯，避免空泛描述。
